<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>上传文件</title>
    <script type="text/javascript" src="/static/js/jquery.js"></script>
    <!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script> -->
    <style type="text/css">
    <!--
      body { text-align: center; margin: 4em; }
      iframe { display: none; }
      .del { display: none; }
      .info { display: none; }
      #error { color: red; font-weight: bold; }
      #preview img { margin: 1em; }
      .preview { display: none; }
      #size { color: #1e90ff; }
      a { text-decoration: none; }
      a:hover { text-decoration: underline; }
    -->
    </style>
    <script type="text/javascript">
    <!--
      for(x in document.open);
      $(document).ready(function(){
	$(':submit').removeAttr('disabled');
	$('iframe').attr('src', 'about:blank');

	$('#addfile').click(function(){
	  $('p.file').last().clone(true).insertAfter($('p.file').last());
	  $(':file').last().val('');
	  $('.del').css('display', 'inline');
	});

	$('.del').click(function(){
	  $(this).parent().remove();
	  if($('p.file').length === 1){
	    $('.del').css('display', 'none');
	  }
	  files_change($('input[type=file]')[0]);
	});

	$(':reset').click(function(){
	  setTimeout(function(){
	    files_change($('input[type=file]')[0]);
	  }, 100);
	});

	var error = function(msg){
	  $('#error').text(msg);
	  $('input').one('click', function(){
	    $('#error').text('');
	  });
	};

	$('form').submit(function(){
	  var files = $(':file');
	  var empty = true;
	  for(var i=0; i<files.length; i++){
	    if(files[i].value)
	      empty = false;
	  }
	  if(empty){
	    error('没有选择文件');
	    return false;
	  }
	  //不能把 :file disable 掉，那样收不到文件
	  $(':submit').attr('disabled', 'true');
	  $('.info').css('display', 'block');
	  //Loadingdotdotdot 会改变 position 属性，进而导致位置出问题
	  $('#info').css('margin-bottom', '3em');
	  if(!$.browser.msie){
	    $("#info").Loadingdotdotdot({
	      text: "文件上传中 ",
	      speed: 300,
	      maxDots: 4
	    });
	  }

	  top.document.title = '正在上传...';

	  top.onbeforeunload = function(){
	    return '上传尚未完成，你确定要离开此页从而中断上传吗？';
	  };

	  return true;
	});

	var files_change = function(fileobj){
	  if(fileobj.files){
	    var preview = $('#preview');
	    var size = 0;
	    var num = 0;
	    preview.empty();
	    $("input[type=file]").each(function(){
	      for(var i=0, len=this.files.length; i<len; i++){
	        var f = this.files[i];
		if(f.getAsDataURL && f.type.indexOf('image')>-1)
		  preview.append('<img height="200" src="'+f.getAsDataURL()+'" title="'+f.name+'"/>');
		size += f.size;
		num++;
	      }
	    });
	    $('#size').text(num+'个文件，总大小：'+(Math.round(size/102.4)/10)+'kB');
	    if(preview.html())
	      $('.preview').show();
	    else
	      $('.preview').hide();
	  }
	};

	$("input[type=file]").change(function(){
          files_change(this);
	});

      });
    //-->
    </script>
  </head>
  <body>
    <noscript><p><strong>注意：您的浏览器不支持或已禁用Javascript，这将导致本应用提示不正确并且大部分功能无法使用。</strong></p></noscript>
    <div>
      <small>在<a href="http://getfirefox.com/" title="立即下载火狐">火狐</a>和<a href="http://www.google.com/chrome" title="立即下载Google Chrome">Google Chrome</a>的最新版中，你可以使用<tt>Ctrl</tt>或<tt>Shift</tt>键选择多个文件。</small>
    </div>
    <div>
      <small>火狐中支持图片预览。</small>
    </div>
    <div>
      <small id="size">对于支持的浏览器，这里会显示文件大小信息</small>
    </div>
    <div>
      <small id="error"></small>
    </div>
    <div id="form">
      <form method="post" enctype="multipart/form-data" target="uploader" action="upload">
	<p class="file">
	  <input type="file" name="file" title="选择要上传的文件" multiple/>
	  <input type="button" class="del" title="删除该项" value="删除"/>
	</p>
	<p>
	  <input type="button" id="addfile" value="添加更多文件"/>
	  <input type="submit" value="开始上传"/>
	  <input type="reset"/>
	</p>
      </form>
      <hr class="preview"/>
      <div id="preview"></div>
      <hr class="info"/>
      <p class="info" id="info">文件上传中</p>
      <p class="info"><small>请耐心等待直到看到上传完成的信息，否则上传将不成功。</small></p>
    </div>
    <script type="text/javascript" src="/static/js/jquery.loadingdotdotdot.js"></script>
    <iframe src="about:blank" name="uploader"></iframe>
  </body>
</html>
